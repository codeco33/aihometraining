<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/default}">
<!-- 사용자 정의 title -->
<th:block layout:fragment="customTitle">
	<title th:text="${title}"></title>
</th:block>
<!-- 사용자 정의 Css -->
<th:block layout:fragment="customCss">
	<link rel="stylesheet" type="text/css" th:href="@{/asset/css/plugins/simple-line-icons.css}" />
	<link rel="stylesheet" type="text/css" th:href="@{/asset/css/plugins/mediaelementplayer.css}" />
	<link rel="stylesheet" type="text/css" th:href="@{/asset/css/plugins/searchPanes.bootstrap.min.css}" />
	<link rel="stylesheet" type="text/css" th:href="@{/asset/css/plugins/select.bootstrap.min.css}" />
</th:block>

<th:block layout:fragment="customContents">
	<div class="col-md-12">
		<div class="panel">
			<div class="panel-body">

				<div class="responsive-table">
					<table id="paymentList" class="table table-striped table-bordered">
						<thead>
							<tr>
								<th>결제코드</th>
								<th>결제자이메일</th>
								<th>카테고리</th>
								<th>결제방식</th>
								<th>결제금액</th>
								<th>결제상태</th>
								<th>결제일</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td><a
									th:href="@{/paymentList/paymentDetail(paymentCode=)}">e20220323_00001</a></td>
								<!-- (paymentCode=${l.paymentCode}) -->
								<td class="searchTd">id005@email.com</td>
								<td class="searchTd">운동클래스</td>
								<td class="searchTd">카드</td>
								<td>137,500</td>
								<td class="searchTd">결제완료</td>
								<td>2022-03-23</td>
							</tr>
							<tr>
								<td><a
									th:href="@{/paymentList/paymentDetail(paymentCode=)}">c20220223_00001</a></td>
								<td class="searchTd">id005@email.com</td>
								<td class="searchTd">챌린지</td>
								<td class="searchTd">현금</td>
								<td>7,500</td>
								<td class="searchTd">결제전</td>
								<td>2022-02-23</td>
							</tr>
							<tr>
								<td><a
									th:href="@{/paymentList/paymentDetail(paymentCode=)}">c20220223_00002</a></td>
								<td class="searchTd">id006@email.com</td>
								<td class="searchTd">챌린지</td>
								<td class="searchTd">현금</td>
								<td>5,000</td>
								<td class="searchTd">결제완료</td>
								<td>2022-02-23</td>
							</tr>
							<tr>
								<td><a
									th:href="@{/paymentList/paymentDetail(paymentCode=)}">e20220224_00001</a></td>
								<td class="searchTd">id006@email.com</td>
								<td class="searchTd">운동클래스</td>
								<td class="searchTd">카드</td>
								<td>12,000</td>
								<td class="searchTd">결제완료</td>
								<td>2022-02-24</td>
							</tr>
							<tr>
								<td><a
									th:href="@{/paymentList/paymentDetail(paymentCode=)}">c20220225_00001</a></td>
								<td class="searchTd">id007@email.com</td>
								<td class="searchTd">챌린지</td>
								<td class="searchTd">현금</td>
								<td>2,000</td>
								<td class="searchTd">결제전</td>
								<td>2022-02-25</td>
							</tr>
							<tr>
								<td><a
									th:href="@{/paymentList/paymentDetail(paymentCode=)}">e20220222_00001</a></td>
								<td class="searchTd">id007@email.com</td>
								<td class="searchTd">운동클래스</td>
								<td class="searchTd">현금</td>
								<td>10,000</td>
								<td class="searchTd">결제완료</td>
								<td>2022-02-22</td>
							</tr>

							<!-- <tr th:if="${not #lists.isEmpty(paymentList)}" th:each="l : ${paymentList}">
								<td th:text="${l.paymentCode}"></td>
								<td th:text="${l.memberEmail}"></td>
								<td th:text="${l.paymentMethodName}"></td>
								<td th:text="${l.paymentTotalOrderPrice}"></td>
								<td th:text="${l.paymentTotalPayPrice}"></td>
								<td th:text="${l.paymentState}"></td>
								<td th:text="${l.paymentRegDate}"></td>
							</tr>
							<tr th:unless="${not #lists.isEmpty(paymentList}">
								<td colspan="7">등록된 결제 내역이 없습니다.</td>
							</tr> -->
						</tbody>
					</table>
				</div>

			</div>
		</div>
	</div>



</th:block>

<th:block layout:fragment="customBodyScript">

	<!-- plugins -->
	<script th:src="@{/asset/js/plugins/moment.min.js}"></script>
	<script th:src="@{/asset/js/plugins/jquery.dataTables.min.js}"></script>
	<script th:src="@{/asset/js/plugins/dataTables.bootstrap.min.js}"></script>
	<script th:src="@{/asset/js/plugins/jquery.nicescroll.js}"></script>
	<script th:src="@{/asset/js/plugins/dataTables.searchPanes.min.js}"></script>
	<script th:src="@{/asset/js/plugins/searchPanes.bootstrap.min.js}"></script>
	<script th:src="@{/asset/js/plugins/dataTables.select.min.js}"></script>
	<script th:src="@{/asset/js/plugins/highcharts.js}"></script>

	<!-- custom -->
	<script th:src="@{/asset/js/main.js}"></script>
	<script type="text/javascript" class="init">
	$(document).ready(function () {
	    // Create DataTable
	    var table = $('#paymentList').DataTable({
	    	dom: 'Pfrtip',
	    	 "initComplete": function () {
		            var api = this.api();
		            api.$('.searchTd').click( function () {
		                api.search( this.innerHTML).draw();
		            } );
		        },
	        searchPanes: {
	            layout: 'columns-3',
	            cascadePanes: true,
	            collapse: false
	        },
	        columnDefs: [
	            {
	                searchPanes: {
	                    show: true,
	                    orderable: false,		                   
	                },
	                targets: [2, 3, 5]
	            },
	            {
	                searchPanes: {
	                    show: false,
	                },
	                targets: [1]
	            }
	        ],
	        "order": [6, 'asc'],
	        "ordering": true,
	        serverSide: false
	    });
	    var salary = getSalaries(table, '카드');
	    var salary2 = getSalaries(table, '현금');
	 
	    // Create the chart with initial data
	    var container = $('<div/>').insertBefore(table.table().container());
	    
	 	// Declare inital series with the values from the getSalaries function
	    /* var series = {
	        name: '카드',
	        data: Object.values(salary),
	    }; */
	 
	    var chart = Highcharts.chart(container[0], {
	        chart: {
	            type: 'column',
	        },
	        title: false,
	        series: [{
	        	name: '카드',
		        data: Object.values(salary)
	        },
	        {
	        	name: '현금',
		        data: Object.values(salary2)
	        }
	        	
	        ],
	        xAxis: {
	        	categories: Object.keys(salary),
	        },
	        yAxis: {
	        	id: 'salary',
	            min: 0,
	            title: {
	                text: '결제 금액'
	            }
	        },
	        plotOptions: {
	            column: {
	                stacking: 'percent'
	            }
	        },
	        tooltip: {
	            pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.percentage:.0f}%)<br/>총 금액: {point.stackTotal}',
	        },
	    });
	    
	    
	 
	    // On each draw, update the data in the chart
	    table.on('draw', function () {
	    	salary = getSalaries(table);
	    	chart.axes[0].categories = Object.keys(salary);
	    	chart.series[0].setData(Object.values(salary));
	    });
	    
	    
	    
	  //날짜별 금액얻기 
	    function getSalaries(table, paymentMethod) {
		    var salaryCounts = {};
		    var salary = {};
		 
		    // Get the row indexes for the rows displayed under the current search
		    var indexes = table.rows({ search: 'applied' }).indexes().toArray();
		 
		    // For each row, extract the office and add the salary to the array
		    for (var i = 0; i < indexes.length; i++) {
		    	
		       var office = table.cell(indexes[i], 6).data();
		       var paymethod = table.cell(indexes[i], 3).data();
			        if (salaryCounts[office] === undefined) {
			        	salaryCounts[office] = [
			                +table
			                    .cell(indexes[i], 4)
			                    .data()
			                    .replace(/[^0-9.]/g, ''),
			            ];
			        	
			        } else {
			        	if(paymethod == paymentMethod){
				            salaryCounts[office].push(
				                +table
				                    .cell(indexes[i], 4)
				                    .data()
				                    .replace(/[^0-9.]/g, '')
				            );
			        	}
			        }
		        
		    }
		 
		    // Extract the office names that are present in the table
		    var keys = Object.keys(salaryCounts);
		 
		    // For each office work out the average salary
		    for (var i = 0; i < keys.length; i++) {
		       // var length = salaryCounts[keys[i]].length;
		      
		        var total = salaryCounts[keys[i]].reduce((a, b) => a + b, 0);
		        salary[keys[i]] = total;
		    }
		 
		    return salary;
		}
	  
	    table.searchPanes.container().prependTo(table.table().container());
		table.searchPanes.resizePanes();
		
		$('.dataTables_scrollBody').css('height', '80px');
	});
	 
	
	
	
	</script>
</th:block>
</html>